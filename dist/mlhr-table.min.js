"use strict";angular.module("datatorrent.mlhrTable.controllers.MlhrTableController",["datatorrent.mlhrTable.services.mlhrTableSortFunctions","datatorrent.mlhrTable.services.mlhrTableFilterFunctions","datatorrent.mlhrTable.services.mlhrTableFormatFunctions"]).controller("MlhrTableController",["$scope","mlhrTableFormatFunctions","mlhrTableSortFunctions","mlhrTableFilterFunctions","$log","$window","$filter","$timeout",function(a,b,c,d,e,f,g){a.addSort=function(b,c){var d=a.sortOrder.indexOf(b);-1===d&&a.sortOrder.push(b),a.sortDirection[b]=c},a.removeSort=function(b){var c=a.sortOrder.indexOf(b);-1!==c&&a.sortOrder.splice(c,1),delete a.sortDirection[b]},a.clearSort=function(){a.sortOrder=[],a.sortDirection={}},a.hasFilterFields=function(){for(var b=a.columns.length-1;b>=0;b--)if("undefined"!=typeof a.columns[b].filter)return!0;return!1},a.toggleSort=function(b,c){if(c.sort){if(b.shiftKey)switch(a.sortDirection[c.id]){case"+":a.sortDirection[c.id]="-";break;case"-":a.removeSort(c.id);break;default:a.addSort(c.id,"+")}else{var d=a.sortDirection[c.id];a.clearSort(),"+"===d?a.addSort(c.id,"-"):a.addSort(c.id,"+")}a.saveToStorage()}},a.getSortClass=function(b){var c=a.options.sort_classes;return"+"===b?c[1]:"-"===b?c[2]:c[0]},a.setColumns=function(f){a.columns=f,a.columns.forEach(function(a){var f=a.format;if("function"!=typeof f)if("string"==typeof f)if("function"==typeof b[f])a.format=b[f];else try{a.format=g(f)}catch(h){delete a.format,e.warn("format function reference in column(id="+a.id+') was not found in built-in format functions or $filters. format function given: "'+f+'". Available built-ins: '+Object.keys(b).join(",")+". If you supplied a $filter, ensure it is available on this module")}else delete a.format;var i=a.sort;"function"!=typeof i&&("string"==typeof i?"function"==typeof c[i]?a.sort=c[i](a.key):(delete a.sort,e.warn("sort function reference in column(id="+a.id+') was not found in built-in sort functions. sort function given: "'+i+'". Available built-ins: '+Object.keys(c).join(",")+". ")):delete a.sort);var j=a.filter;"function"!=typeof j&&("string"==typeof j?"function"==typeof d[j]?a.filter=d[j]:(delete a.filter,e.warn("filter function reference in column(id="+a.id+') was not found in built-in filter functions. filter function given: "'+j+'". Available built-ins: '+Object.keys(d).join(",")+". ")):delete a.filter)})},a.startColumnResize=function(b,c){function d(a){var b=a.pageX,c=b-g;e=j+c,h.css("width",e+"px")}b.preventDefault(),b.originalEvent.preventDefault(),b.stopPropagation();var e=!1,g=b.pageX,h=$('<div class="column-resizer-marquee"></div>'),i=$(b.target).parent("th");i.append(h);var j=i.outerWidth();h.css({width:j+"px",height:i.outerHeight()+"px"}),$(f).on("mousemove",d),$(f).one("mouseup",function(b){b.stopPropagation(),h.remove(),$(f).off("mousemove",d),e===!1?delete c.width:c.width=Math.max(e,0),a.$apply()})},a.sortableOptions={axis:"x",handle:".column-text",helper:"clone",placeholder:"mlhr-table-column-placeholder"},a.getActiveColCount=function(){var b=0;return a.columns.forEach(function(a){a.disabled||b++}),b},a.saveToStorage=function(){if(a.storage){var b={};["sortOrder","sortDirection","searchTerms"].forEach(function(c){b[c]=a[c]}),b.columns=a.columns.map(function(a){return{id:a.id,disabled:!!a.disabled}}),b.options={},["rowLimit","pagingScheme"].forEach(function(c){b.options[c]=a.options[c]}),a.storage.setItem(a.storage_key,JSON.stringify(b))}},a.loadFromStorage=function(){if(a.storage){var b=a.storage.getItem(a.storage_key);if(b){var c;try{c=JSON.parse(b),["sortOrder","sortDirection","searchTerms"].forEach(function(b){a[b]=c[b]});var d=c.columns.map(function(a){return a.id});a.columns.sort(function(a,b){return d.indexOf(a.id)-d.indexOf(b.id)}),a.columns.forEach(function(a,b){["disabled"].forEach(function(d){a[d]=c.columns[b][d]})}),["rowLimit","pagingScheme"].forEach(function(b){a.options[b]=c.options[b]})}catch(f){e.warn("Loading from storage failed!")}}}},a.calculateRowLimit=function(){var b=a.scrollDiv.find(".mlhr-table-rendered-rows tr").height();b&&(a.rowHeight=b,a.rowLimit=Math.ceil(a.options.bodyHeight/b)+2*a.options.rowPadding)}}]),angular.module("datatorrent.mlhrTable.directives.mlhrTable",["datatorrent.mlhrTable.controllers.MlhrTableController","datatorrent.mlhrTable.directives.mlhrTableRows","datatorrent.mlhrTable.directives.mlhrTableDummyRows"]).directive("mlhrTable",["$log","$timeout","$q",function(a,b,c){function d(a,c,d){var e,f,g,h,i,j=function(){var k=Date.now()-h;c>k&&k>0?e=b(j,c-k):(e=null,d||(i=a.apply(g,f),e||(g=f=null)))};return function(){g=this,f=arguments,h=Date.now();var k=d&&!e;return e||(e=b(j,c)),k&&(i=a.apply(g,f),g=f=null),i}}function e(a){if("object"!=typeof a)return a;for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];for(var e in d)void 0===a[e]&&(a[e]=d[e])}return a}function f(a,f){if("undefined"==typeof a.trackBy&&(a.trackBy="id"),!(a.columns instanceof Array))throw new Error('"columns" array not found in mlhrTable scope!');if(a.setColumns(a.columns),!(a.rows instanceof Array))throw new Error('"rows" array not found in mlhrTable scope!');a.searchTerms={},a.sortOrder=[],a.sortDirection={},a.filterState={filterCount:a.rows.length},a.rowOffset=0,a.rowLimit=10,a.options=a.options||{},e(a.options,{bgSizeMultiplier:1,rowPadding:10,bodyHeight:300,defaultRowHeight:40,defaultRowLimit:15,scrollDebounce:100,scrollDivisor:1,loadingText:"loading",noRowsText:"no rows",setLoading:function(b){this.loading=b,a.$digest()},trackBy:a.trackBy,sort_classes:["glyphicon glyphicon-sort","glyphicon glyphicon-chevron-up","glyphicon glyphicon-chevron-down"]}),a.rowLimit=a.options.defaultRowLimit,a.rowHeight=a.options.defaultRowHeight,a.options.initial_sorts&&angular.forEach(a.options.initial_sorts,function(b){a.addSort(b.id,b.dir)}),a.options.storage&&a.options.storage_key&&(a.storage=a.options.storage,a.storage_key=a.options.storage_key,a.loadFromStorage(),a.$watchCollection("columns",a.saveToStorage),a.$watchCollection("searchTerms",a.saveToStorage),a.$watch("options.pagingScheme",a.saveToStorage),a.$watch("options.bodyHeight",function(){a.calculateRowLimit(),a.saveToStorage()}),a.$watch("filterState.filterCount",function(){a.onScroll()}),a.$watch("rowHeight",function(b){console.log("rowHeight changed:",b,arguments[1]),f.find("tr.mlhr-table-dummy-row").css("background-size","auto "+b*a.options.bgSizeMultiplier+"px")}));var g,h=d(function(){a.calculateRowLimit();var b=a.scrollDiv[0].scrollTop,c=a.rowHeight;return 0===c?!1:(a.rowOffset=Math.max(0,Math.floor(b/c)-a.options.rowPadding),g.resolve(),g=null,a.options.scrollingPromise=null,void a.$digest())},a.options.scrollDebounce);a.onScroll=function(){g||(g=c.defer(),a.options.scrollingPromise=g.promise),h()},a.scrollDiv=f.find(".mlhr-rows-table-wrapper"),a.scrollDiv.on("scroll",a.onScroll),b(function(){a.calculateRowLimit()},0)}return{templateUrl:"src/templates/mlhrTable.tpl.html",restrict:"EA",replace:!0,scope:{columns:"=",rows:"=",classes:"@tableClass",selected:"=",options:"=?",trackBy:"@?"},controller:"MlhrTableController",compile:function(a){return a.attr("track-by")||a.attr("track-by","id"),f}}}]),angular.module("datatorrent.mlhrTable.directives.mlhrTableCell",["datatorrent.mlhrTable.directives.mlhrTableSelector"]).directive("mlhrTableCell",["$compile",function(a){function b(b,c){var d=b.column,e="";e=d.template?d.template:d.templateUrl?"<div ng-include=\"'"+d.templateUrl+"'\"></div>":d.selector===!0?'<input type="checkbox" ng-checked="selected.indexOf(row[column.key]) >= 0" mlhr-table-selector class="mlhr-table-selector" />':d.ngFilter?"{{ row[column.key] | "+d.ngFilter+":row }}":d.format?"{{ column.format(row[column.key], row, column) }}":"{{ row[column.key] }}",c.html(e),a(c.contents())(b)}return{scope:!0,link:b}}]),angular.module("datatorrent.mlhrTable.directives.mlhrTableDummyRows",[]).directive("mlhrTableDummyRows",function(){return{template:'<tr class="mlhr-table-dummy-row" ng-style="{ height: dummyRowHeight + \'px\'}"><td ng-show="dummyRowHeight" ng-attr-colspan="{{columns.length}}"></td></tr>',scope:!0,link:function(a,b,c){a.$watch(c.mlhrTableDummyRows,function(b){a.dummyRowHeight=b*a.rowHeight})}}}),angular.module("datatorrent.mlhrTable.directives.mlhrTableRows",["datatorrent.mlhrTable.directives.mlhrTableCell","datatorrent.mlhrTable.filters.mlhrTableRowFilter","datatorrent.mlhrTable.filters.mlhrTableRowSorter"]).directive("mlhrTableRows",["$filter",function(a){function b(a){var b;return b=c(a.rows,a.columns,a.searchTerms,a.filterState),b=d(b,a.columns,a.sortOrder,a.sortDirection),b=e(b,Math.floor(a.rowOffset)-a.filterState.filterCount),b=e(b,a.rowLimit+Math.ceil(a.rowOffset%1))}var c=a("mlhrTableRowFilter"),d=a("mlhrTableRowSorter"),e=a("limitTo");return{restrict:"A",templateUrl:"src/templates/mlhrTableRows.tpl.html",link:function(a){a.visible_rows=a.rows.slice();var c=function(){a.visible_rows=b(a)};a.$watch("searchTerms",c,!0),a.$watchGroup(["filterState","sortOrder","sortDirection","rowOffset","rowLimit"],c),a.$watchCollection("rows",c)}}}]),angular.module("datatorrent.mlhrTable.directives.mlhrTableSelector",[]).directive("mlhrTableSelector",function(){return{restrict:"A",scope:!1,link:function(a,b){var c=a.selected,d=a.row,e=a.column;b.on("click",function(){var b=c.indexOf(d[e.key]);b>=0?c.splice(b,1):c.push(d[e.key]),a.$apply()})}}}),angular.module("datatorrent.mlhrTable.filters.mlhrTableRowFilter",["datatorrent.mlhrTable.services.mlhrTableFilterFunctions"]).filter("mlhrTableRowFilter",["mlhrTableFilterFunctions","$log",function(a,b){return function(c,d,e,f){var g,h=c;return g=d.filter(function(c){var d=e[c.id];if(e.hasOwnProperty(c.id)&&"string"==typeof d){if(!d.trim())return!1;if("function"==typeof c.filter)return!0;var f=a[c.filter];if("function"==typeof f)return c.filter=f,!0;b.warn('mlhrTable: The filter function "'+c.filter+'" specified by column(id='+c.id+').filter was not found in predefined tableFilterFunctions. Available filters: "'+Object.keys(a).join('","')+'"')}return!1}),g.length&&(h=c.filter(function(a){for(var b=g.length-1;b>=0;b--){var c=g[b],d=c.filter,f=e[c.id],h=a[c.key],i="function"==typeof c.format?c.format(h,a):h;if(!d(f,h,i,a))return!1}return!0})),f.filterCount=h.length,h}}]),angular.module("datatorrent.mlhrTable.filters.mlhrTableRowSorter",[]).filter("mlhrTableRowSorter",function(){function a(a,c){if(b.hasOwnProperty(c))return b[c];for(var d=a.length-1;d>=0;d--)if(a[d].id===c)return b[c]=a[d],a[d]}var b={};return function(b,c,d,e){if(!d.length)return b;for(var f=[],g=0;g<b.length;g++)f.push(b[g]);return f.sort(function(b,f){for(var g=0;g<d.length;g++){var h=d[g],i=a(c,h),j=e[h];if(i&&i.sort){var k=i.sort,l="+"===j?k(b,f):k(f,b);if(0!==l)return l}}return 0})}}),angular.module("datatorrent.mlhrTable",["datatorrent.mlhrTable.templates","ui.sortable","ngSanitize","monospaced.mousewheel","datatorrent.mlhrTable.directives.mlhrTable"]),angular.module("datatorrent.mlhrTable.services.mlhrTableFilterFunctions",[]).service("mlhrTableFilterFunctions",function(){function a(a,b){a=a.toLowerCase().trim(),b=b.toLowerCase();var c=a[0];return"!"===c?(a=a.substr(1),""===a?!0:-1===b.indexOf(a)):"="===c?(a=a.substr(1),a===b.trim()):(a=a.replace("\\!","!"),a=a.replace("\\=","="),-1!==b.indexOf(a))}function b(b,c,d,e){return a(b,d,d,e)}function c(a,b){b=parseFloat(b),a=a.trim();var c=a.substr(0,2),d=a[0],e=1*a.substr(1),f=1*a.substr(2);return"<="===c?f>=b:">="===c?b>=f:"<"===d?e>b:">"===d?b>e:"~"===d?Math.round(b)===e:"="===d?e===b:b.toString().indexOf(a.toString())>-1}function d(a,b,d){return c(a,d)}function e(a){for(var b=a.trim().split(","),c=0,d=0;d<b.length;d++){var e=b[d].trim(),f=h.exec(e);if(f){var i=1*f[1],j=f[2].replace(/s$/,"");g.hasOwnProperty(j)&&(c+=i*g[j])}}return c}function f(a,b){if(a=a.trim(),!a)return!0;b*=1;var c,d,f=new Date,h=+f,i=a[0],j=a.substr(1).trim();if("<"===i)return c=h-e(j),b>c;if(">"===i)return d=h-e(j),d>b;if("today"===a)return new Date(b).toDateString()===f.toDateString();if("yesterday"===a)return new Date(b).toDateString()===new Date(h-g.d).toDateString();var k=new Date(a);return isNaN(k)?!1:new Date(b).toDateString()===k.toDateString()}a.placeholder=b.placeholder="string search",a.title=b.title='Search by text, eg. "foo". Use "!" to exclude and "=" to match exact text, e.g. "!bar" or "=baz".',c.placeholder=d.placeholder="number search",c.title=d.title='Search by number, e.g. "123". Optionally use comparator expressions like ">=10" or "<1000". Use "~" for approx. int values, eg. "~3" will match "3.2"';var g={};g.second=g.sec=g.s=1e3,g.minute=g.min=g.m=60*g.second,g.hour=g.hr=g.h=60*g.minute,g.day=g.d=24*g.hour,g.week=g.wk=g.w=7*g.day,g.month=4*g.week,g.year=g.yr=g.y=365*g.day;var h=/(\d+(?:\.\d+)?)\s*([a-z]+)/;return f.placeholder="date search",f.title='Search by date. Enter a date string (RFC2822 or ISO 8601 date). You can also type "today", "yesterday", "> 2 days ago", "< 1 day 2 hours ago", etc.',{like:a,likeFormatted:b,number:c,numberFormatted:d,date:f}}),angular.module("datatorrent.mlhrTable.services.mlhrTableFormatFunctions",[]).service("mlhrTableFormatFunctions",function(){return{}}),angular.module("datatorrent.mlhrTable.services.mlhrTableSortFunctions",[]).service("mlhrTableSortFunctions",function(){return{number:function(a){return function(b,c){return b[a]-c[a]}},string:function(a){return function(b,c){return b[a].toString().toLowerCase()===c[a].toString().toLowerCase()?0:b[a].toString().toLowerCase()>c[a].toString().toLowerCase()?1:-1}}}}),angular.module("datatorrent.mlhrTable.templates",["src/templates/mlhrTable.tpl.html","src/templates/mlhrTableDummyRows.tpl.html","src/templates/mlhrTableRows.tpl.html"]),angular.module("src/templates/mlhrTable.tpl.html",[]).run(["$templateCache",function(a){a.put("src/templates/mlhrTable.tpl.html",'<div class="mlhr-table-wrapper">\n  <table ng-class="classes" class="mlhr-table mlhr-header-table">\n    <thead>\n      <tr ui-sortable="sortableOptions" ng-model="columns">\n        <th \n          scope="col" \n          ng-repeat="column in columns" \n          ng-click="toggleSort($event,column)" \n          ng-class="{\'sortable-column\' : column.sort}" \n          ng-attr-title="{{ column.title || \'\' }}"\n          ng-style="{ width: column.width, \'min-width\': column.width, \'max-width\': column.width }"\n        >\n          <span class="column-text">\n            {{column.hasOwnProperty(\'label\') ? column.label : column.id }}\n            <span \n              ng-if="column.sort" \n              title="This column is sortable. Click to toggle sort order. Hold shift while clicking multiple columns to stack sorting."\n              class="sorting-icon {{ getSortClass( sortDirection[column.id] ) }}"\n            ></span>\n          </span>\n          <span \n            ng-if="!column.lock_width"\n            ng-class="{\'discreet-width\': !!column.width, \'column-resizer\': true}"\n            title="Click and drag to set discreet width. Click once to clear discreet width."\n            ng-mousedown="startColumnResize($event, column)"\n          >\n            &nbsp;\n          </span>\n        </th>\n      </tr>\n      <tr ng-if="hasFilterFields()" class="mlhr-table-filter-row">\n        <th ng-repeat="column in columns">\n          <input \n            type="search"\n            ng-if="(column.filter)"\n            ng-model="searchTerms[column.id]"\n            ng-attr-placeholder="{{ column.filter && column.filter.placeholder }}"\n            ng-attr-title="{{ column.filter && column.filter.title }}"\n            ng-class="{\'active\': searchTerms[column.id] }"\n          >\n        </th>\n      </tr>\n    </thead>\n  </table>\n  <div class="mlhr-rows-table-wrapper" ng-style="{ height: options.bodyHeight + \'px\' }">\n    <table ng-class="classes" class="mlhr-table mlhr-rows-table">\n      <thead>\n        <th \n            scope="col"\n            ng-repeat="column in columns" \n            ng-style="{ width: column.width, \'min-width\': column.width, \'max-width\': column.width }"\n          ></th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr ng-if="visible_rows.length === 0">\n          <td ng-attr-colspan="{{columns.length}}" class="space-holder-row-cell">\n            <div ng-if="options.loading && options.loadingTemplateUrl" ng-include="options.loadingTemplateUrl"></div>\n            <div ng-if="options.loading && !options.loadingTemplateUrl">{{ options.loadingText }}</div>\n            <div ng-if="!options.loading && options.noRowsTemplateUrl" ng-include="options.noRowsTemplateUrl"></div>\n            <div ng-if="!options.loading && !options.noRowsTemplateUrl">{{ options.noRowsText }}</div>\n          </td>\n        </tr>\n      </tbody>\n      <tbody mlhr-table-dummy-rows="rowOffset" columns="columns" cell-content="..."></tbody>\n      <tbody mlhr-table-rows class="mlhr-table-rendered-rows"></tbody>\n      <tbody mlhr-table-dummy-rows="filterState.filterCount - rowOffset - visible_rows.length" columns="columns" cell-content="..."></tbody>\n    </table>\n  </div>\n</div>\n')}]),angular.module("src/templates/mlhrTableDummyRows.tpl.html",[]).run(["$templateCache",function(a){a.put("src/templates/mlhrTableDummyRows.tpl.html","")}]),angular.module("src/templates/mlhrTableRows.tpl.html",[]).run(["$templateCache",function(a){a.put("src/templates/mlhrTableRows.tpl.html",'<tr ng-repeat="row in visible_rows track by row[options.trackBy]" ng-attr-class="{{ (rowOffset + $index) % 2 ? \'odd\' : \'even\' }}">\n  <td ng-repeat="column in columns track by column.id" class="mlhr-table-cell" mlhr-table-cell></td>\n</tr>')}]);